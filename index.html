<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WatchVIM CMS Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            watchBlack: "#0a0a0a",
            watchRed: "#e50914",
            watchGold: "#d4af37"
          }
        }
      }
    }
  </script>

  <!-- Mux Player (for previews) -->
  <script src="https://unpkg.com/@mux/mux-player@latest/dist/mux-player.js"></script>

  <style>
    body { background:#0a0a0a; color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .input { background:#111; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:8px 10px; width:100%; }
    .label { font-size:12px; color:rgba(255,255,255,.7); }
    .pill { font-size:11px; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.08); }
    .pill-active { background:rgba(255,255,255,.2); }
    .btn { padding:8px 12px; border-radius:10px; background:rgba(255,255,255,.1); }
    .btn:hover { background:rgba(255,255,255,.16); }
    .btn-red { background:#e50914; font-weight:700; }
    .btn-red:hover { background:#ff1f2b; }
    .card { background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:14px; }
    .row-scroll { display:flex; gap:8px; overflow-x:auto; padding-bottom:6px; }
    .row-scroll::-webkit-scrollbar { height:8px; }
    .row-scroll::-webkit-scrollbar-thumb { background:#222; border-radius:999px; }
    .muted { color: rgba(255,255,255,.65); }
    .small { font-size:12px; }
    .danger { color:#ffb3b3; }
    a { color:#d4af37; }

    #debugPane {
      position: fixed; bottom: 10px; right: 10px; width: 360px; max-height: 40vh;
      background: rgba(0,0,0,.9); border:1px solid rgba(255,255,255,.12); border-radius: 12px;
      padding: 10px; font-size: 12px; overflow: auto; display:none; z-index: 9999;
    }
    #debugPane .line { white-space: pre-wrap; border-bottom:1px dashed rgba(255,255,255,.08); padding:4px 0; }
  </style>
</head>

<body>
<div class="min-h-screen grid grid-cols-[260px_1fr]">

  <!-- Sidebar -->
  <aside class="border-r border-white/10 p-4 space-y-3">
    <div class="flex items-center gap-2 mb-4">
      <!-- LOGO (replace src in production with /WatchVIM_New_OTT_Logo.png after adding to /public) -->
      <img
        src="/mnt/data/WatchVIM_New_OTT_Logo.png"
        alt="WatchVIM Logo"
        class="w-10 h-10 object-contain rounded-md bg-white/10 p-1"
      />
      <div>
        <div class="text-lg font-bold">WatchVIM</div>
        <div class="text-xs text-white/60">CMS Portal</div>
      </div>
    </div>

    <!-- ONLY TABS: Dashboard + Content -->
    <nav class="space-y-1">
      <button class="w-full text-left btn" onclick="navTo('dashboard')">Dashboard</button>
      <button class="w-full text-left btn" onclick="navTo('content')">Content</button>
    </nav>

    <div class="pt-4 border-t border-white/10 text-xs text-white/60">
      Local-first CMS. Save often. Publish when ready.
    </div>

    <div class="pt-2 text-xs">
      <button class="btn w-full" onclick="toggleDebug()">Toggle Debug Console</button>
    </div>
  </aside>

  <!-- Main -->
  <main id="main" class="p-6 space-y-6"></main>
</div>

<div id="debugPane"></div>

<script>
/* =========================================================
   WATCHVIM CMS (single-file SPA)
========================================================= */

/* ========= DEBUG ========= */
const debugPane = document.getElementById("debugPane");
function logDebug(msg){
  if(!debugPane) return;
  debugPane.style.display = "block";
  const line = document.createElement("div");
  line.className="line";
  line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  debugPane.prepend(line);
}
function toggleDebug(){
  debugPane.style.display = (debugPane.style.display==="none"||!debugPane.style.display) ? "block" : "none";
}
window.addEventListener("error", (e)=> logDebug("JS Error: " + e.message));
window.addEventListener("unhandledrejection", (e)=> logDebug("Promise Rejection: " + (e.reason?.message||e.reason)));

/* =====================
   STATE + STORAGE
===================== */

const LS_KEYS = {
  CMS_STATE: "watchvim_cms_state_v7",
  NAV_STACK: "watchvim_nav_stack_v7",
};

function defaultState(){
  return {
    titles: [],               // films/documentaries/shorts/foreign/series
    loopChannel: {
      rotationItems: [],      // { id, refType:'title'|'episode', refId, label }
      adFrequencyMins: 12,
      shuffle: true,
      sponsoredAds: []        // { id, name, fileUrl, muxAdPlaybackId, durationSec }
    },
    payment: {
      paypalClientId: "",
      paypalEnv: "sandbox"
    },
    publish: {
      stableManifestKey: "manifest.json",
      stableCatalogKey: "catalog.json"
    },
    analytics: {
      views7d: 0,
      minutesWatched7d: 0,
      newUsers7d: 0,
      revenue7d: 0
    },
    lastPublished: null,
    version: 1
  };
}

let cmsState = loadState();
let navStack = loadNavStack();
window.__watchvimCMS = cmsState;

function loadState(){
  const raw = localStorage.getItem(LS_KEYS.CMS_STATE);
  if(!raw) return defaultState();
  try {
    const parsed = JSON.parse(raw);
    const merged = { ...defaultState(), ...parsed };
    merged.loopChannel = { ...defaultState().loopChannel, ...(parsed.loopChannel||{}) };
    merged.payment = { ...defaultState().payment, ...(parsed.payment||{}) };
    merged.publish = { ...defaultState().publish, ...(parsed.publish||{}) };
    merged.analytics = { ...defaultState().analytics, ...(parsed.analytics||{}) };
    return merged;
  } catch {
    return defaultState();
  }
}
function saveState(){
  localStorage.setItem(LS_KEYS.CMS_STATE, JSON.stringify(cmsState));
}
function loadNavStack(){
  const raw = localStorage.getItem(LS_KEYS.NAV_STACK);
  if(!raw) return [];
  try { return JSON.parse(raw); } catch { return []; }
}
function saveNavStack(){
  localStorage.setItem(LS_KEYS.NAV_STACK, JSON.stringify(navStack));
}

function pushNav(route){
  navStack.push(route);
  saveNavStack();
}
function goBack(){
  if(navStack.length <= 1){
    navTo("dashboard", {push:false});
    return;
  }
  navStack.pop();
  const prev = navStack[navStack.length-1] || "dashboard";
  saveNavStack();
  navTo(prev, {push:false});
}

function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
}

/* =====================
   ROUTER
===================== */

function navTo(route, opts={push:true}){
  if(opts.push) pushNav(route);
  render(route);
}

function render(route){
  const main = document.getElementById("main");
  if(!main) return;

  const [section, a, b, c] = route.split(":");

  if(section==="dashboard") return renderDashboard();

  // NEW unified content hub
  if(section==="content") return renderContentHome(a);

  // Back-compat (old routes remain if stored in navStack)
  if(section==="titles") return renderTitlesList();
  if(section==="titleEdit") return renderTitleEdit(a);

  if(section==="series") return renderSeriesList();
  if(section==="seriesEdit") return renderSeriesEdit(a);
  if(section==="seasonEdit") return renderSeasonEdit(a, Number(b));
  if(section==="episodeEdit") return renderEpisodeEdit(a, Number(b), Number(c));

  if(section==="loop") return renderLoop();
  if(section==="users") return renderUsersPlaceholder();
  if(section==="settings") return renderSettings();
  if(section==="publish") return renderPublish();

  renderDashboard();
}

/* =====================
   UPLOAD (server -> Vercel Blob)
   FIXED: hardened response parsing & metadata
===================== */

async function uploadToBlob(file, keyPrefix="watchvim"){
  try{
    if(!file) return null;

    const MAX = 4.2 * 1024 * 1024;
    if(file.size > MAX){
      alert("File is over 4MB. Please resize/compress before uploading.");
      return null;
    }

    const fd = new FormData();
    fd.append("file", file, file.name);
    fd.append("filename", file.name);
    fd.append("contentType", file.type || "application/octet-stream");
    fd.append("keyPrefix", keyPrefix);
    fd.append("cacheBust", Date.now().toString());

    const res = await fetch("/api/upload", {
      method:"POST",
      body: fd,
      credentials: "same-origin"
    });

    const txt = await res.text();
    if(!res.ok){
      throw new Error(txt || "Upload failed");
    }

    let data = {};
    try { data = JSON.parse(txt); } catch { data = {}; }

    const url =
      data.url ||
      data.blob?.url ||
      data.data?.url ||
      data.result?.url ||
      data.upload?.url;

    if(!url){
      throw new Error("Upload succeeded but no URL returned from /api/upload.");
    }

    return { url, ...data };
  }catch(e){
    logDebug("uploadToBlob failed: " + e.message);
    alert("Upload failed: " + e.message);
    throw e;
  }
}

/* =====================
   SHARED HELPERS
===================== */

const h = (label, value) => `<div class="pill">${label}: <b>${value}</b></div>`;

function typeBadge(type){
  const map = {
    films:"Films",
    documentaries:"Documentaries",
    series:"Series",
    shorts:"Shorts",
    foreign:"Foreign"
  };
  return map[type] || type || "Uncategorized";
}
function getTitleById(id){ return cmsState.titles.find(t=>t.id===id); }
function byType(type){ return cmsState.titles.filter(t=>t.type===type); }

function splitGenres(str){
  return (str||"").split(",").map(x=>x.trim()).filter(Boolean);
}
function tagify(arr){
  return (arr||[]).join(", ");
}

function renderMuxPreview(playbackId){
  if(!playbackId) return `<div class="text-xs text-white/60">Enter a Mux Playback ID to preview.</div>`;
  return `
    <mux-player
      class="w-full rounded-xl overflow-hidden border border-white/10 bg-black/50 aspect-video"
      playback-id="${playbackId}"
      stream-type="on-demand"
      controls
    ></mux-player>
  `;
}

/* =========================================================
   DASHBOARD
========================================================= */

function renderDashboard(){
  const main = document.getElementById("main");

  const total = cmsState.titles.length;
  const published = cmsState.titles.filter(t=>t.isPublished).length;
  const seriesCount = byType("series").length;
  const shortsCount = byType("shorts").length;
  const analytics = cmsState.analytics || defaultState().analytics;

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Dashboard</h1>
      <div class="flex gap-2">
        <button class="btn" onclick="navTo('content')">Manage Content</button>
        <button class="btn btn-red" onclick="navTo('publish')">Publish</button>
      </div>
    </div>

    <div class="grid grid-cols-4 gap-3">
      <div class="card">${h("Total Titles", total)}</div>
      <div class="card">${h("Published", published)}</div>
      <div class="card">${h("Series", seriesCount)}</div>
      <div class="card">${h("Shorts", shortsCount)}</div>
    </div>

    <div class="grid grid-cols-4 gap-3">
      <div class="card space-y-1">
        <div class="text-xs text-white/60">Views (7d)</div>
        <div class="text-2xl font-bold">${analytics.views7d}</div>
        <div class="text-xs text-white/50">Connect Supabase/Mux later</div>
      </div>
      <div class="card space-y-1">
        <div class="text-xs text-white/60">Minutes Watched (7d)</div>
        <div class="text-2xl font-bold">${analytics.minutesWatched7d}</div>
        <div class="text-xs text-white/50">Connect Supabase/Mux later</div>
      </div>
      <div class="card space-y-1">
        <div class="text-xs text-white/60">New Users (7d)</div>
        <div class="text-2xl font-bold">${analytics.newUsers7d}</div>
        <div class="text-xs text-white/50">Supabase auth.users</div>
      </div>
      <div class="card space-y-1">
        <div class="text-xs text-white/60">Revenue (7d)</div>
        <div class="text-2xl font-bold">$${Number(analytics.revenue7d||0).toFixed(2)}</div>
        <div class="text-xs text-white/50">PayPal/Ads later</div>
      </div>
    </div>

    <div class="card small muted">
      <div class="font-semibold mb-1">Publishing Pipeline (Stable)</div>
      CMS → Publish → overwrites <code>${cmsState.publish.stableCatalogKey}</code> and <code>${cmsState.publish.stableManifestKey}</code> in Blob.
      Your frontend should point to the stable Manifest URL once and never change it.
    </div>
  `;
}

/* =========================================================
   CONTENT HUB (ALL TYPES)
========================================================= */

function renderContentHome(filter="all"){
  const main = document.getElementById("main");
  const current = filter || "all";

  const filters = [
    { key:"all", label:"All" },
    { key:"films", label:"Films" },
    { key:"series", label:"Series" },
    { key:"documentaries", label:"Documentaries" },
    { key:"shorts", label:"Shorts" },
    { key:"foreign", label:"Foreign" },
  ];

  const items = current==="all" ? cmsState.titles : byType(current);

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Content</h1>
      <div class="flex gap-2">
        <button class="btn btn-red" onclick="createContent('${current}')">
          + New ${current==="series" ? "Series" : "Title"}
        </button>
        <button class="btn" onclick="navTo('publish')">Publish</button>
      </div>
    </div>

    <div class="row-scroll">
      ${filters.map(f => `
        <button
          class="pill ${f.key===current ? "pill-active" : ""}"
          onclick="navTo('content:${f.key}')"
        >${f.label}</button>
      `).join("")}
    </div>

    <div class="grid grid-cols-5 gap-3">
      ${
        items.map(t => {
          const isSeries = t.type==="series";
          return `
            <div class="card cursor-pointer" onclick="navTo('${isSeries ? "seriesEdit" : "titleEdit"}:${t.id}')">
              <div class="aspect-[2/3] rounded-xl overflow-hidden bg-white/5 border border-white/10">
                <img src="${t.posterUrl||''}" class="w-full h-full object-cover"/>
              </div>
              <div class="mt-2 font-semibold line-clamp-2">${t.title|| (isSeries ? "Untitled Series" : "Untitled")}</div>
              <div class="text-xs text-white/60 flex gap-1 flex-wrap items-center">
                <span class="pill">${typeBadge(t.type)}</span>
                ${isSeries ? `<span class="pill">${(t.seasons||[]).length} seasons</span>` : ``}
                ${t.isPublished?`<span class="pill bg-green-600/20">Published</span>`:""}
              </div>
            </div>
          `;
        }).join("") || `<div class="text-white/60 text-sm">No content yet.</div>`
      }
    </div>
  `;
}

function createContent(type){
  if(type==="series") return createSeries();
  return createTitle(type==="all" ? "films" : type);
}

/* =========================================================
   TITLES LIST (non-series)  [legacy route]
========================================================= */

function renderTitlesList(){
  const main = document.getElementById("main");
  const titles = cmsState.titles.filter(t=>t.type!=="series");

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Movies / Docs / Shorts / Foreign</h1>
      <div class="flex gap-2">
        <button class="btn" onclick="goBack()">Back</button>
        <button class="btn btn-red" onclick="createTitle()">+ New Title</button>
      </div>
    </div>

    <div class="grid grid-cols-5 gap-3">
      ${
        titles.map(t=>`
          <div class="card cursor-pointer" onclick="navTo('titleEdit:${t.id}')">
            <div class="aspect-[2/3] rounded-xl overflow-hidden bg-white/5 border border-white/10">
              <img src="${t.posterUrl||''}" class="w-full h-full object-cover"/>
            </div>
            <div class="mt-2 font-semibold line-clamp-2">${t.title||"Untitled"}</div>
            <div class="text-xs text-white/60 flex gap-1 flex-wrap">
              <span class="pill">${typeBadge(t.type)}</span>
              ${t.isPublished?`<span class="pill bg-green-600/20">Published</span>`:""}
            </div>
          </div>
        `).join("")
      }
    </div>
  `;
}

function createTitle(presetType="films"){
  const t = {
    id: uid("title"),
    type: presetType,
    title: "",
    synopsis: "",
    genre: [],
    releaseYear: "",
    runtimeMins: "",
    language: "English",
    rating: "",
    posterUrl: "",
    heroUrl: "",
    trailerPlaybackId: "",
    contentPlaybackId: "",
    isPublished: false,
    monetization: {
      svod: true,
      avod: false,
      tvod: { enabled:false, rentalPrice:"", rentalWindowHours:48, buyPrice:"" }
    },
    appImages: {
      mobileHeroUrl:"",
      mobilePosterUrl:"",
      tvHeroUrl:"",
      tvPosterUrl:""
    }
  };

  cmsState.titles.push(t);
  saveState();
  navTo("titleEdit:"+t.id);
}

/* =========================================================
   TITLE EDITOR
========================================================= */

function renderTitleEdit(id){
  const main = document.getElementById("main");
  const t = getTitleById(id);
  if(!t) return navTo("content");

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Edit Title</h1>
      <div class="flex gap-2">
        <button class="btn" onclick="goBack()">Back</button>
        <button class="btn btn-red" onclick="saveTitle('${id}')">Save</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-6">
      <div class="space-y-3">
        <div class="card space-y-2">
          <div class="font-semibold">Poster (2:3)</div>
          <div class="aspect-[2/3] bg-white/5 rounded-xl overflow-hidden border border-white/10">
            <img id="posterPreview" src="${t.posterUrl||''}" class="w-full h-full object-cover"/>
          </div>
          <input id="posterInput" type="file" accept="image/*" class="input"/>
          <button class="btn w-full" onclick="uploadPoster('${id}')">Upload Poster</button>
        </div>

        <div class="card space-y-2">
          <div class="font-semibold">Hero (16:9)</div>
          <div class="aspect-video bg-white/5 rounded-xl overflow-hidden border border-white/10">
            <img id="heroPreview" src="${t.heroUrl||''}" class="w-full h-full object-cover"/>
          </div>
          <input id="heroInput" type="file" accept="image/*" class="input"/>
          <button class="btn w-full" onclick="uploadHero('${id}')">Upload Hero</button>
        </div>
      </div>

      <div class="space-y-4">
        <div class="card space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <div class="label">Type</div>
              <select id="type" class="input">
                ${["films","documentaries","shorts","foreign"].map(x=>
                  `<option value="${x}" ${t.type===x?"selected":""}>${typeBadge(x)}</option>`
                ).join("")}
              </select>
            </div>
            <div>
              <div class="label">Release Year</div>
              <input id="releaseYear" class="input" value="${t.releaseYear||""}"/>
            </div>
          </div>

          <div><div class="label">Title</div><input id="title" class="input" value="${t.title||""}"/></div>
          <div><div class="label">Synopsis</div><textarea id="synopsis" class="input" rows="4">${t.synopsis||""}</textarea></div>

          <div class="grid grid-cols-3 gap-3">
            <div><div class="label">Runtime (mins)</div><input id="runtimeMins" class="input" value="${t.runtimeMins||""}"/></div>
            <div><div class="label">Language</div><input id="language" class="input" value="${t.language||""}"/></div>
            <div><div class="label">Rating</div><input id="rating" class="input" value="${t.rating||""}"/></div>
          </div>

          <div><div class="label">Genres (comma separated)</div><input id="genre" class="input" value="${tagify(t.genre)}"/></div>

          <div class="grid grid-cols-2 gap-3">
            <div><div class="label">Trailer Mux Playback ID</div><input id="trailerPlaybackId" class="input" value="${t.trailerPlaybackId||""}"/></div>
            <div><div class="label">Content Mux Playback ID</div><input id="contentPlaybackId" class="input" value="${t.contentPlaybackId||""}"/></div>
          </div>

          <!-- Mux previews -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 pt-2">
            <div class="card space-y-2">
              <div class="text-xs text-white/60">Trailer Preview</div>
              ${renderMuxPreview(t.trailerPlaybackId)}
            </div>
            <div class="card space-y-2">
              <div class="text-xs text-white/60">Content Preview</div>
              ${renderMuxPreview(t.contentPlaybackId)}
            </div>
          </div>

          <div class="flex items-center gap-2">
            <input id="isPublished" type="checkbox" ${t.isPublished?"checked":""}/>
            <label for="isPublished" class="text-sm">Published</label>
          </div>
        </div>

        <div class="card space-y-3">
          <div class="font-semibold">Monetization (multiple allowed)</div>
          <div class="flex flex-wrap gap-4 text-sm">
            <label class="flex items-center gap-2"><input id="svod" type="checkbox" ${t.monetization?.svod?"checked":""}/> SVOD</label>
            <label class="flex items-center gap-2"><input id="avod" type="checkbox" ${t.monetization?.avod?"checked":""}/> AVOD</label>
            <label class="flex items-center gap-2"><input id="tvodEnabled" type="checkbox" ${t.monetization?.tvod?.enabled?"checked":""} onchange="toggleTVODFields()"/> TVOD</label>
          </div>
          <div id="tvodFields" class="${t.monetization?.tvod?.enabled?'':'hidden'} grid grid-cols-3 gap-3">
            <div><div class="label">Rental Price ($)</div><input id="rentalPrice" class="input" value="${t.monetization?.tvod?.rentalPrice||""}"/></div>
            <div><div class="label">Rental Window (hrs)</div><input id="rentalWindowHours" class="input" value="${t.monetization?.tvod?.rentalWindowHours||48}"/></div>
            <div><div class="label">Buy Price ($)</div><input id="buyPrice" class="input" value="${t.monetization?.tvod?.buyPrice||""}"/></div>
          </div>
          <div class="text-xs text-white/60">Enable any combo of SVOD + AVOD + TVOD.</div>
        </div>

        <div class="card space-y-3">
          <div class="font-semibold">Mobile + TV App Images</div>
          <div class="grid grid-cols-2 gap-3">
            ${renderAppImageUpload(id,"mobileHeroUrl","Mobile Hero (9:16)","aspect-[9/16]","mobileHeroInput","mobileHeroPreview")}
            ${renderAppImageUpload(id,"mobilePosterUrl","Mobile Poster (2:3)","aspect-[2/3]","mobilePosterInput","mobilePosterPreview")}
            ${renderAppImageUpload(id,"tvHeroUrl","TV Hero (16:9)","aspect-video","tvHeroInput","tvHeroPreview")}
            ${renderAppImageUpload(id,"tvPosterUrl","TV Poster (2:3)","aspect-[2/3]","tvPosterInput","tvPosterPreview")}
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderAppImageUpload(id, field, label, aspect, inputId, previewId){
  const t = getTitleById(id);
  return `
    <div class="space-y-2">
      <div class="label">${label}</div>
      <img id="${previewId}" src="${t.appImages?.[field]||''}"
           class="w-full ${aspect} object-cover rounded-xl border border-white/10 bg-white/5"/>
      <input id="${inputId}" type="file" accept="image/*" class="input"/>
      <button class="btn w-full" onclick="uploadAppImage('${id}','${field}','${inputId}','${previewId}')">Upload</button>
    </div>
  `;
}

function toggleTVODFields(){
  const enabled = document.getElementById("tvodEnabled")?.checked;
  document.getElementById("tvodFields")?.classList.toggle("hidden", !enabled);
}

async function uploadPoster(id){
  try{
    const f = document.getElementById("posterInput").files[0];
    if(!f) return;
    const out = await uploadToBlob(f, `titles/${id}/poster`);
    const t = getTitleById(id);
    t.posterUrl = out.url;
    saveState();
    document.getElementById("posterPreview").src = out.url;
  }catch(e){}
}

async function uploadHero(id){
  try{
    const f = document.getElementById("heroInput").files[0];
    if(!f) return;
    const out = await uploadToBlob(f, `titles/${id}/hero`);
    const t = getTitleById(id);
    t.heroUrl = out.url;
    saveState();
    document.getElementById("heroPreview").src = out.url;
  }catch(e){}
}

async function uploadAppImage(id, field, inputId, previewId){
  try{
    const f = document.getElementById(inputId).files[0];
    if(!f) return;
    const out = await uploadToBlob(f, `titles/${id}/apps/${field}`);
    const t = getTitleById(id);
    t.appImages = t.appImages || {};
    t.appImages[field] = out.url;
    saveState();
    document.getElementById(previewId).src = out.url;
  }catch(e){}
}

function saveTitle(id){
  const t = getTitleById(id);

  t.type = document.getElementById("type").value;
  t.title = document.getElementById("title").value.trim();
  t.synopsis = document.getElementById("synopsis").value.trim();
  t.genre = splitGenres(document.getElementById("genre").value);
  t.releaseYear = document.getElementById("releaseYear").value.trim();
  t.runtimeMins = document.getElementById("runtimeMins").value.trim();
  t.language = document.getElementById("language").value.trim();
  t.rating = document.getElementById("rating").value.trim();
  t.trailerPlaybackId = document.getElementById("trailerPlaybackId").value.trim();
  t.contentPlaybackId = document.getElementById("contentPlaybackId").value.trim();
  t.isPublished = document.getElementById("isPublished").checked;

  t.monetization = t.monetization || {};
  t.monetization.svod = document.getElementById("svod").checked;
  t.monetization.avod = document.getElementById("avod").checked;
  t.monetization.tvod = t.monetization.tvod || {};
  t.monetization.tvod.enabled = document.getElementById("tvodEnabled").checked;
  t.monetization.tvod.rentalPrice = document.getElementById("rentalPrice")?.value.trim() || "";
  t.monetization.tvod.rentalWindowHours = Number(document.getElementById("rentalWindowHours")?.value || 48);
  t.monetization.tvod.buyPrice = document.getElementById("buyPrice")?.value.trim() || "";

  if(!t.monetization.svod && !t.monetization.avod && !t.monetization.tvod.enabled){
    alert("Enable at least one monetization option.");
    return;
  }

  saveState();
  alert("Saved.");
}

/* =========================================================
   SERIES / SEASONS / EPISODES
========================================================= */

function renderSeriesList(){
  const main = document.getElementById("main");
  const series = byType("series");

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Series</h1>
      <div class="flex gap-2">
        <button class="btn" onclick="goBack()">Back</button>
        <button class="btn btn-red" onclick="createSeries()">+ New Series</button>
      </div>
    </div>

    <div class="grid grid-cols-5 gap-3">
      ${
        series.map(s=>`
          <div class="card cursor-pointer" onclick="navTo('seriesEdit:${s.id}')">
            <div class="aspect-[2/3] rounded-xl overflow-hidden bg-white/5 border border-white/10">
              <img src="${s.posterUrl||''}" class="w-full h-full object-cover"/>
            </div>
            <div class="mt-2 font-semibold line-clamp-2">${s.title||"Untitled Series"}</div>
            <div class="text-xs text-white/60">${(s.seasons||[]).length} seasons</div>
          </div>
        `).join("")
      }
    </div>
  `;
}

function createSeries(){
  const s = {
    id: uid("series"),
    type: "series",
    title: "",
    synopsis: "",
    genre: [],
    releaseYear: "",
    language: "English",
    posterUrl: "",
    heroUrl: "",
    trailerPlaybackId: "",
    contentPlaybackId: "",
    isPublished: false,
    monetization: {
      svod: true,
      avod: false,
      tvod: { enabled:false, rentalPrice:"", rentalWindowHours:48, buyPrice:"" }
    },
    appImages: { mobileHeroUrl:"", mobilePosterUrl:"", tvHeroUrl:"", tvPosterUrl:"" },
    seasons: []
  };

  cmsState.titles.push(s);
  saveState();
  navTo("seriesEdit:"+s.id);
}

function renderSeriesEdit(seriesId){
  const main = document.getElementById("main");
  const s = getTitleById(seriesId);
  if(!s) return navTo("content:series");

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Edit Series</h1>
      <div class="flex gap-2">
        <button class="btn" onclick="goBack()">Back</button>
        <button class="btn btn-red" onclick="saveSeries('${seriesId}')">Save Series</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-6">
      <div class="space-y-3">
        <div class="card space-y-2">
          <div class="font-semibold">Series Poster</div>
          <div class="aspect-[2/3] bg-white/5 rounded-xl overflow-hidden border border-white/10">
            <img id="seriesPosterPreview" src="${s.posterUrl||''}" class="w-full h-full object-cover"/>
          </div>
          <input id="seriesPosterInput" type="file" accept="image/*" class="input"/>
          <button class="btn w-full" onclick="uploadSeriesPoster('${seriesId}')">Upload Poster</button>
        </div>

        <div class="card space-y-2">
          <div class="font-semibold">Series Hero</div>
          <div class="aspect-video bg-white/5 rounded-xl overflow-hidden border border-white/10">
            <img id="seriesHeroPreview" src="${s.heroUrl||''}" class="w-full h-full object-cover"/>
          </div>
          <input id="seriesHeroInput" type="file" accept="image/*" class="input"/>
          <button class="btn w-full" onclick="uploadSeriesHero('${seriesId}')">Upload Hero</button>
        </div>
      </div>

      <div class="space-y-4">
        <div class="card space-y-3">
          <div class="label">Series Title</div>
          <input id="seriesTitle" class="input" value="${s.title||""}"/>

          <div class="label">Synopsis</div>
          <textarea id="seriesSynopsis" class="input" rows="4">${s.synopsis||""}</textarea>

          <div class="label">Genres (comma separated)</div>
          <input id="seriesGenre" class="input" value="${tagify(s.genre)}"/>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <div class="label">Release Year</div>
              <input id="seriesReleaseYear" class="input" value="${s.releaseYear||""}"/>
            </div>
            <div>
              <div class="label">Language</div>
              <input id="seriesLanguage" class="input" value="${s.language||""}"/>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <div class="label">Trailer Playback ID</div>
              <input id="seriesTrailerPlaybackId" class="input" value="${s.trailerPlaybackId||""}"/>
            </div>
            <div>
              <div class="label">Series Content Playback ID (optional)</div>
              <input id="seriesContentPlaybackId" class="input" value="${s.contentPlaybackId||""}"/>
            </div>
          </div>

          <!-- Mux previews -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 pt-2">
            <div class="card space-y-2">
              <div class="text-xs text-white/60">Trailer Preview</div>
              ${renderMuxPreview(s.trailerPlaybackId)}
            </div>
            <div class="card space-y-2">
              <div class="text-xs text-white/60">Content Preview</div>
              ${renderMuxPreview(s.contentPlaybackId)}
            </div>
          </div>

          <label class="flex items-center gap-2 text-sm">
            <input id="seriesPublished" type="checkbox" ${s.isPublished?"checked":""}/>
            Published
          </label>
        </div>

        <div class="card space-y-2">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Seasons</div>
            <button class="btn" onclick="addSeason('${seriesId}')">+ Add Season</button>
          </div>
          <div class="space-y-2">
            ${
              (s.seasons||[]).map((season, idx)=>`
                <div class="card flex items-center justify-between">
                  <div>
                    <div class="font-semibold">Season ${season.seasonNumber}</div>
                    <div class="text-xs text-white/60">${(season.episodes||[]).length} episodes</div>
                  </div>
                  <div class="flex gap-2">
                    <button class="btn" onclick="navTo('seasonEdit:${seriesId}:${idx}')">Edit</button>
                    <button class="btn" onclick="removeSeason('${seriesId}',${idx})">Remove</button>
                  </div>
                </div>
              `).join("") || `<div class="text-white/60 text-sm">No seasons yet.</div>`
            }
          </div>
        </div>
      </div>
    </div>
  `;
}

async function uploadSeriesPoster(seriesId){
  try{
    const f = document.getElementById("seriesPosterInput").files[0];
    if(!f) return;
    const out = await uploadToBlob(f, `series/${seriesId}/poster`);
    const s = getTitleById(seriesId);
    s.posterUrl = out.url;
    saveState();
    document.getElementById("seriesPosterPreview").src = out.url;
  }catch(e){}
}
async function uploadSeriesHero(seriesId){
  try{
    const f = document.getElementById("seriesHeroInput").files[0];
    if(!f) return;
    const out = await uploadToBlob(f, `series/${seriesId}/hero`);
    const s = getTitleById(seriesId);
    s.heroUrl = out.url;
    saveState();
    document.getElementById("seriesHeroPreview").src = out.url;
  }catch(e){}
}

function saveSeries(seriesId){
  const s = getTitleById(seriesId);
  s.title = document.getElementById("seriesTitle").value.trim();
  s.synopsis = document.getElementById("seriesSynopsis").value.trim();
  s.genre = splitGenres(document.getElementById("seriesGenre").value);
  s.releaseYear = document.getElementById("seriesReleaseYear").value.trim();
  s.language = document.getElementById("seriesLanguage").value.trim();
  s.trailerPlaybackId = document.getElementById("seriesTrailerPlaybackId").value.trim();
  s.contentPlaybackId = document.getElementById("seriesContentPlaybackId").value.trim();
  s.isPublished = document.getElementById("seriesPublished").checked;

  saveState();
  alert("Series saved.");
}

function addSeason(seriesId){
  const s = getTitleById(seriesId);
  const nextNum = (s.seasons||[]).length + 1;
  s.seasons.push({
    seasonNumber: nextNum,
    title: `Season ${nextNum}`,
    synopsis: "",
    posterUrl: "",
    heroUrl: "",
    episodes: []
  });
  saveState();
  navTo(`seasonEdit:${seriesId}:${nextNum-1}`);
}

function removeSeason(seriesId, seasonIndex){
  const s = getTitleById(seriesId);
  s.seasons.splice(seasonIndex,1);
  s.seasons.forEach((x,i)=>x.seasonNumber=i+1);
  saveState();
  renderSeriesEdit(seriesId);
}

function renderSeasonEdit(seriesId, seasonIndex){
  const main = document.getElementById("main");
  const s = getTitleById(seriesId);
  const season = s?.seasons?.[seasonIndex];
  if(!season) return navTo("seriesEdit:"+seriesId);

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Season ${season.seasonNumber}</h1>
      <div class="flex gap-2">
        <button class="btn" onclick="goBack()">Back</button>
        <button class="btn btn-red" onclick="saveSeason('${seriesId}',${seasonIndex})">Save Season</button>
      </div>
    </div>

    <div class="card space-y-3">
      <div>
        <div class="label">Season Title</div>
        <input id="seasonTitle" class="input" value="${season.title||""}"/>
      </div>
      <div>
        <div class="label">Season Synopsis</div>
        <textarea id="seasonSynopsis" class="input" rows="3">${season.synopsis||""}</textarea>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div class="space-y-2">
          <div class="label">Season Poster</div>
          <img id="seasonPosterPreview" src="${season.posterUrl||''}"
               class="w-full aspect-[2/3] object-cover rounded-xl border border-white/10 bg-white/5"/>
          <input id="seasonPosterInput" type="file" accept="image/*" class="input"/>
          <button class="btn w-full" onclick="uploadSeasonPoster('${seriesId}',${seasonIndex})">Upload Poster</button>
        </div>
        <div class="space-y-2">
          <div class="label">Season Hero</div>
          <img id="seasonHeroPreview" src="${season.heroUrl||''}"
               class="w-full aspect-video object-cover rounded-xl border border-white/10 bg-white/5"/>
          <input id="seasonHeroInput" type="file" accept="image/*" class="input"/>
          <button class="btn w-full" onclick="uploadSeasonHero('${seriesId}',${seasonIndex})">Upload Hero</button>
        </div>
      </div>
    </div>

    <div class="card space-y-2">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Episodes</div>
        <button class="btn" onclick="addEpisode('${seriesId}',${seasonIndex})">+ Add Episode</button>
      </div>

      <div class="space-y-2">
        ${
          (season.episodes||[]).map((ep, epIdx)=>`
            <div class="card flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img src="${ep.thumbnailUrl||''}" class="w-14 h-20 object-cover rounded-md bg-white/5 border border-white/10"/>
                <div>
                  <div class="font-semibold">E${ep.episodeNumber} — ${ep.title||"Untitled"}</div>
                  <div class="text-xs text-white/60">${ep.runtimeMins||""} mins</div>
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn" onclick="navTo('episodeEdit:${seriesId}:${seasonIndex}:${epIdx}')">Edit</button>
                <button class="btn" onclick="removeEpisode('${seriesId}',${seasonIndex},${epIdx})">Remove</button>
              </div>
            </div>
          `).join("") || `<div class="text-white/60 text-sm">No episodes yet.</div>`
        }
      </div>
    </div>
  `;
}

async function uploadSeasonPoster(seriesId, seasonIndex){
  try{
    const f = document.getElementById("seasonPosterInput").files[0];
    if(!f) return;
    const out = await uploadToBlob(f, `series/${seriesId}/season-${seasonIndex+1}/poster`);
    const s = getTitleById(seriesId);
    s.seasons[seasonIndex].posterUrl = out.url;
    saveState();
    document.getElementById("seasonPosterPreview").src = out.url;
  }catch(e){}
}
async function uploadSeasonHero(seriesId, seasonIndex){
  try{
    const f = document.getElementById("seasonHeroInput").files[0];
    if(!f) return;
    const out = await uploadToBlob(f, `series/${seriesId}/season-${seasonIndex+1}/hero`);
    const s = getTitleById(seriesId);
    s.seasons[seasonIndex].heroUrl = out.url;
    saveState();
    document.getElementById("seasonHeroPreview").src = out.url;
  }catch(e){}
}

function saveSeason(seriesId, seasonIndex){
  const s = getTitleById(seriesId);
  const season = s.seasons[seasonIndex];
  season.title = document.getElementById("seasonTitle").value.trim();
  season.synopsis = document.getElementById("seasonSynopsis").value.trim();
  saveState();
  alert("Season saved.");
}

function addEpisode(seriesId, seasonIndex){
  const s = getTitleById(seriesId);
  const season = s.seasons[seasonIndex];
  const nextNum = (season.episodes||[]).length + 1;

  season.episodes.push({
    id: uid("episode"),
    episodeNumber: nextNum,
    title: "",
    synopsis: "",
    runtimeMins: "",
    thumbnailUrl: "",
    trailerPlaybackId: "",
    contentPlaybackId: "",
    isPublished: false,
    monetization: JSON.parse(JSON.stringify(s.monetization)),
    appImages: { mobileHeroUrl:"", mobilePosterUrl:"", tvHeroUrl:"", tvPosterUrl:"" }
  });

  saveState();
  navTo(`episodeEdit:${seriesId}:${seasonIndex}:${nextNum-1}`);
}

function removeEpisode(seriesId, seasonIndex, epIndex){
  const s = getTitleById(seriesId);
  s.seasons[seasonIndex].episodes.splice(epIndex,1);
  s.seasons[seasonIndex].episodes.forEach((x,i)=>x.episodeNumber=i+1);
  saveState();
  renderSeasonEdit(seriesId, seasonIndex);
}

function renderEpisodeEdit(seriesId, seasonIndex, epIndex){
  const main = document.getElementById("main");
  const s = getTitleById(seriesId);
  const ep = s?.seasons?.[seasonIndex]?.episodes?.[epIndex];
  if(!ep) return navTo(`seasonEdit:${seriesId}:${seasonIndex}`);

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Edit Episode</h1>
      <div class="flex gap-2">
        <button class="btn" onclick="goBack()">Back</button>
        <button class="btn btn-red" onclick="saveEpisode('${seriesId}',${seasonIndex},${epIndex})">Save Episode</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-6">
      <div class="card space-y-2">
        <div class="font-semibold">Episode Thumbnail (2:3)</div>
        <div class="aspect-[2/3] bg-white/5 rounded-xl overflow-hidden border border-white/10">
          <img id="epThumbPreview" src="${ep.thumbnailUrl||''}" class="w-full h-full object-cover"/>
        </div>
        <input id="epThumbInput" type="file" accept="image/*" class="input"/>
        <button class="btn w-full" onclick="uploadEpisodeThumb('${seriesId}',${seasonIndex},${epIndex})">Upload Thumbnail</button>
      </div>

      <div class="space-y-4">
        <div class="card space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div><div class="label">Episode #</div><input id="epNumber" class="input" value="${ep.episodeNumber}"/></div>
            <div><div class="label">Runtime (mins)</div><input id="epRuntime" class="input" value="${ep.runtimeMins||""}"/></div>
          </div>

          <div><div class="label">Episode Title</div><input id="epTitle" class="input" value="${ep.title||""}"/></div>
          <div><div class="label">Synopsis</div><textarea id="epSynopsis" class="input" rows="3">${ep.synopsis||""}</textarea></div>

          <div class="grid grid-cols-2 gap-3">
            <div><div class="label">Trailer Playback ID</div><input id="epTrailer" class="input" value="${ep.trailerPlaybackId||""}"/></div>
            <div><div class="label">Content Playback ID</div><input id="epContent" class="input" value="${ep.contentPlaybackId||""}"/></div>
          </div>

          <!-- Mux previews -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 pt-2">
            <div class="card space-y-2">
              <div class="text-xs text-white/60">Trailer Preview</div>
              ${renderMuxPreview(ep.trailerPlaybackId)}
            </div>
            <div class="card space-y-2">
              <div class="text-xs text-white/60">Content Preview</div>
              ${renderMuxPreview(ep.contentPlaybackId)}
            </div>
          </div>

          <label class="flex items-center gap-2 text-sm">
            <input id="epPublished" type="checkbox" ${ep.isPublished?"checked":""}/> Published
          </label>
        </div>
      </div>
    </div>
  `;
}

async function uploadEpisodeThumb(seriesId, seasonIndex, epIndex){
  try{
    const f = document.getElementById("epThumbInput").files[0];
    if(!f) return;
    const out = await uploadToBlob(f, `series/${seriesId}/season-${seasonIndex+1}/episode-${epIndex+1}/thumb`);
    const s = getTitleById(seriesId);
    s.seasons[seasonIndex].episodes[epIndex].thumbnailUrl = out.url;
    saveState();
    document.getElementById("epThumbPreview").src = out.url;
  }catch(e){}
}

function saveEpisode(seriesId, seasonIndex, epIndex){
  const s = getTitleById(seriesId);
  const ep = s.seasons[seasonIndex].episodes[epIndex];

  ep.episodeNumber = Number(document.getElementById("epNumber").value || ep.episodeNumber);
  ep.title = document.getElementById("epTitle").value.trim();
  ep.synopsis = document.getElementById("epSynopsis").value.trim();
  ep.runtimeMins = document.getElementById("epRuntime").value.trim();
  ep.trailerPlaybackId = document.getElementById("epTrailer").value.trim();
  ep.contentPlaybackId = document.getElementById("epContent").value.trim();
  ep.isPublished = document.getElementById("epPublished").checked;

  s.seasons[seasonIndex].episodes.sort((a,b)=>a.episodeNumber-b.episodeNumber);
  s.seasons[seasonIndex].episodes.forEach((x,i)=>x.episodeNumber=i+1);

  saveState();
  alert("Episode saved.");
}

/* =========================================================
   LOOP / USERS / SETTINGS / PUBLISH (UNCHANGED)
   Keeping as-is for your stable frontend pipeline.
========================================================= */

/* ====== LOOP CHANNEL (same as your file) ====== */
function flattenAllRefs(){
  const titles = cmsState.titles.filter(t => t.type !== "series");
  const series = cmsState.titles.filter(t => t.type === "series");

  const episodes = [];
  series.forEach(s => {
    (s.seasons||[]).forEach((season, si) => {
      (season.episodes||[]).forEach((ep, ei) => {
        episodes.push({
          id: ep.id,
          label: `${s.title||"Series"} — S${season.seasonNumber||si+1}E${ep.episodeNumber||ei+1} • ${ep.title||"Untitled"}`,
          seriesId: s.id
        });
      });
    });
  });

  return { titles, episodes, series };
}

function addRotationItem(){
  const sel = document.getElementById("loopAddSelect");
  const val = sel.value;
  if(!val) return;

  const [refType, refId] = val.split("|");
  const { titles, episodes } = flattenAllRefs();

  let label = "";
  if(refType === "title"){
    const t = titles.find(x => x.id === refId) || getTitleById(refId);
    label = t?.title || "Untitled Title";
  } else {
    const ep = episodes.find(x => x.id === refId);
    label = ep?.label || "Untitled Episode";
  }

  cmsState.loopChannel.rotationItems.push({
    id: uid("loopItem"),
    refType,
    refId,
    label
  });

  saveState();
  renderLoop();
}

function removeRotationItem(itemId){
  cmsState.loopChannel.rotationItems =
    cmsState.loopChannel.rotationItems.filter(x => x.id !== itemId);
  saveState();
  renderLoop();
}

function moveRotationItem(itemId, dir){
  const items = cmsState.loopChannel.rotationItems;
  const idx = items.findIndex(x => x.id === itemId);
  if(idx < 0) return;
  const newIdx = idx + dir;
  if(newIdx < 0 || newIdx >= items.length) return;
  const [it] = items.splice(idx,1);
  items.splice(newIdx,0,it);
  saveState();
  renderLoop();
}

function saveLoopSettings(){
  cmsState.loopChannel.adFrequencyMins =
    Number(document.getElementById("adFrequencyMins").value || 12);
  cmsState.loopChannel.shuffle =
    document.getElementById("loopShuffle").checked;
  saveState();
  alert("Loop settings saved.");
}

async function addSponsoredAd(){
  const name = document.getElementById("adName").value.trim();
  const muxAdPlaybackId = document.getElementById("adMuxId").value.trim();
  const durationSec = Number(document.getElementById("adDuration").value || 15);
  const file = document.getElementById("adFile").files[0];

  let fileUrl = "";
  if(file){
    const out = await uploadToBlob(file, "loop/ads");
    fileUrl = out.url;
  }

  cmsState.loopChannel.sponsoredAds.push({
    id: uid("ad"),
    name,
    fileUrl,
    muxAdPlaybackId,
    durationSec
  });

  saveState();
  renderLoop();
}

function removeSponsoredAd(adId){
  cmsState.loopChannel.sponsoredAds =
    cmsState.loopChannel.sponsoredAds.filter(a => a.id !== adId);
  saveState();
  renderLoop();
}

function renderLoop(){
  const main = document.getElementById("main");
  const loop = cmsState.loopChannel;
  const { titles, episodes } = flattenAllRefs();

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Loop Channel</h1>
      <div class="flex gap-2">
        <button class="btn" onclick="goBack()">Back</button>
        <button class="btn btn-red" onclick="saveLoopSettings()">Save Loop</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

      <div class="card space-y-3">
        <div class="font-semibold">Rotation</div>

        <div class="flex gap-2">
          <select id="loopAddSelect" class="input">
            <option value="">+ Add title or episode…</option>
            <optgroup label="Titles">
              ${titles.map(t=>`
                <option value="title|${t.id}">
                  ${t.title||"Untitled"} (${typeBadge(t.type)})
                </option>
              `).join("")}
            </optgroup>
            <optgroup label="Episodes">
              ${episodes.map(ep=>`
                <option value="episode|${ep.id}">
                  ${ep.label}
                </option>
              `).join("")}
            </optgroup>
          </select>
          <button class="btn" onclick="addRotationItem()">Add</button>
        </div>

        <div class="space-y-2">
          ${
            (loop.rotationItems||[]).map((it, i)=>`
              <div class="card flex items-center justify-between">
                <div class="text-sm">
                  <div class="font-semibold">${i+1}. ${it.label}</div>
                  <div class="text-xs text-white/60">${it.refType} • ${it.refId}</div>
                </div>
                <div class="flex gap-1">
                  <button class="btn" onclick="moveRotationItem('${it.id}',-1)">↑</button>
                  <button class="btn" onclick="moveRotationItem('${it.id}',1)">↓</button>
                  <button class="btn" onclick="removeRotationItem('${it.id}')">Remove</button>
                </div>
              </div>
            `).join("") || `<div class="text-white/60 text-sm">No rotation items yet.</div>`
          }
        </div>
      </div>

      <div class="card space-y-3">
        <div class="font-semibold">Loop Settings</div>

        <div>
          <div class="label">Ad Frequency (mins)</div>
          <input id="adFrequencyMins" class="input" value="${loop.adFrequencyMins||12}" />
        </div>

        <label class="flex items-center gap-2 text-sm">
          <input id="loopShuffle" type="checkbox" ${loop.shuffle?"checked":""}/>
          Shuffle Rotation
        </label>

        <div class="text-xs text-white/60">
          Rotation items will play in order unless shuffle is enabled.
        </div>
      </div>
    </div>

    <div class="card space-y-3">
      <div class="font-semibold">Sponsored Ads (optional)</div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
        <input id="adName" class="input" placeholder="Ad name"/>
        <input id="adMuxId" class="input" placeholder="Mux Ad Playback ID (optional)"/>
        <input id="adDuration" class="input" placeholder="Duration sec" value="15"/>
        <input id="adFile" type="file" accept="video/*,image/*" class="input"/>
      </div>
      <button class="btn" onclick="addSponsoredAd()">+ Add Sponsored Ad</button>

      <div class="space-y-2">
        ${
          (loop.sponsoredAds||[]).map(ad=>`
            <div class="card flex items-center justify-between">
              <div>
                <div class="font-semibold">${ad.name||"Unnamed Ad"}</div>
                <div class="text-xs text-white/60">
                  ${ad.durationSec||15}s • ${ad.muxAdPlaybackId||"no mux id"}
                </div>
                ${ad.fileUrl ? `<div class="text-xs break-all">${ad.fileUrl}</div>` : ""}
              </div>
              <button class="btn" onclick="removeSponsoredAd('${ad.id}')">Remove</button>
            </div>
          `).join("") || `<div class="text-white/60 text-sm">No sponsored ads yet.</div>`
        }
      </div>
    </div>
  `;
}

/* ====== USERS (same as your file) ====== */
const SUPA_LS = "watchvim_supabase_admin_cfg_v1";
let supaAdminClient = null;

function loadSupaCfg(){
  try { return JSON.parse(localStorage.getItem(SUPA_LS)||"{}"); }
  catch { return {}; }
}
function saveSupaCfg(cfg){
  localStorage.setItem(SUPA_LS, JSON.stringify(cfg));
}

function loadSupabaseScript(){
  return new Promise((resolve, reject) => {
    if(window.supabase) return resolve();
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

async function initSupaAdmin(){
  const url = document.getElementById("supaUrl").value.trim();
  const key = document.getElementById("supaServiceKey").value.trim();
  if(!url || !key) throw new Error("Missing Supabase URL or Service Role Key.");

  await loadSupabaseScript();
  supaAdminClient = window.supabase.createClient(url, key, {
    auth: { persistSession: false }
  });

  saveSupaCfg({ url, key });
  alert("Supabase connected.");
  return supaAdminClient;
}

async function fetchUsers(){
  try{
    if(!supaAdminClient) await initSupaAdmin();

    const { data, error } = await supaAdminClient.auth.admin.listUsers({
      page: 1, perPage: 100
    });
    if(error) throw error;

    renderUsersTable(data.users || []);
  }catch(e){
    logDebug("fetchUsers failed: " + e.message);
    alert("Fetch users failed: " + e.message);
  }
}

function renderUsersTable(users){
  const el = document.getElementById("usersTable");
  if(!el) return;

  el.innerHTML = `
    <div class="text-xs text-white/60 mb-2">${users.length} users</div>
    <div class="space-y-2">
      ${users.map(u=>`
        <div class="card flex items-center justify-between">
          <div>
            <div class="font-semibold text-sm">${u.email || "no-email"}</div>
            <div class="text-xs text-white/60">
              created: ${new Date(u.created_at).toLocaleString()}
              ${u.last_sign_in_at ? `• last login: ${new Date(u.last_sign_in_at).toLocaleString()}` : ""}
            </div>
          </div>
          <div class="text-xs pill">${u.role || "authenticated"}</div>
        </div>
      `).join("") || `<div class="text-white/60 text-sm">No users returned.</div>`}
    </div>
  `;
}

function renderUsersPlaceholder(){
  const main = document.getElementById("main");
  const cfg = loadSupaCfg();

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Users (Supabase)</h1>
      <button class="btn" onclick="goBack()">Back</button>
    </div>

    <div class="card space-y-3">
      <div class="danger small">
        ⚠️ Use a Supabase <b>Service Role Key</b> here ONLY for your private CMS.
        Do not expose this portal publicly.
      </div>

      <div>
        <div class="label">Supabase Project URL</div>
        <input id="supaUrl" class="input" placeholder="https://xxxx.supabase.co" value="${cfg.url||""}"/>
      </div>

      <div>
        <div class="label">Service Role Key (secret)</div>
        <input id="supaServiceKey" class="input" placeholder="paste key" value="${cfg.key||""}"/>
      </div>

      <div class="flex gap-2">
        <button class="btn" onclick="initSupaAdmin()">Connect</button>
        <button class="btn btn-red" onclick="fetchUsers()">Fetch Users</button>
      </div>
    </div>

    <div id="usersTable" class="mt-4"></div>
  `;
}

/* ====== SETTINGS (same as your file) ====== */
function renderSettings(){
  const main = document.getElementById("main");
  const p = cmsState.payment || {};
  const pub = cmsState.publish || {};

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Settings</h1>
      <div class="flex gap-2">
        <button class="btn" onclick="goBack()">Back</button>
        <button class="btn btn-red" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card space-y-3">
        <div class="font-semibold">PayPal Gateway (Public)</div>

        <div>
          <div class="label">PayPal Client ID (public)</div>
          <input id="paypalClientId" class="input" value="${p.paypalClientId||""}"/>
        </div>

        <div>
          <div class="label">Environment</div>
          <select id="paypalEnv" class="input">
            <option value="sandbox" ${p.paypalEnv==="sandbox"?"selected":""}>Sandbox</option>
            <option value="live" ${p.paypalEnv==="live"?"selected":""}>Live</option>
          </select>
        </div>

        <div class="text-xs text-white/60">
          Never store PayPal Secret in the CMS. Keep secrets in backend env only.
        </div>
      </div>

      <div class="card space-y-3">
        <div class="font-semibold">Publishing (Stable URLs)</div>

        <div>
          <div class="label">Stable Manifest Key</div>
          <input id="stableManifestKey" class="input" value="${pub.stableManifestKey||"manifest.json"}"/>
          <div class="text-xs text-white/60 mt-1">Frontend should point here once.</div>
        </div>

        <div>
          <div class="label">Stable Catalog Key</div>
          <input id="stableCatalogKey" class="input" value="${pub.stableCatalogKey||"catalog.json"}"/>
        </div>
      </div>
    </div>
  `;
}

function saveSettings(){
  cmsState.payment = cmsState.payment || {};
  cmsState.publish = cmsState.publish || {};

  cmsState.payment.paypalClientId = document.getElementById("paypalClientId").value.trim();
  cmsState.payment.paypalEnv = document.getElementById("paypalEnv").value;
  cmsState.publish.stableManifestKey = document.getElementById("stableManifestKey").value.trim() || "manifest.json";
  cmsState.publish.stableCatalogKey = document.getElementById("stableCatalogKey").value.trim() || "catalog.json";
  saveState();
  alert("Settings saved.");
}

/* ====== PUBLISH (same as your file) ====== */
function renderPublish(){
  const main = document.getElementById("main");
  const last = cmsState.lastPublished;
  const stableManifestKey = cmsState.publish.stableManifestKey || "manifest.json";

  main.innerHTML = `
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Publish</h1>
      <button class="btn" onclick="goBack()">Back</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card space-y-3">
        <div class="font-semibold">Publish Catalog (Stable)</div>
        <div class="text-sm text-white/70">
          Publishes ONLY items with “Published” checked.
          Overwrites stable <code>${cmsState.publish.stableCatalogKey}</code> and <code>${stableManifestKey}</code>.
        </div>

        <button class="btn btn-red w-full" onclick="publishCatalog()">Publish to Apps</button>
        <div id="publishResult" class="text-xs text-white/60 break-all"></div>
      </div>

      <div class="card space-y-2">
        <div class="font-semibold">Last Published</div>
        <div class="text-sm text-white/70">
          ${last ? new Date(last.time).toLocaleString() : "Never"}
        </div>
        ${last ? `
          <div class="text-xs text-white/60 break-all">Stable Manifest: ${last.stableManifestUrl||last.manifestUrl||""}</div>
          <div class="text-xs text-white/60 break-all">Stable Catalog: ${last.stableCatalogUrl||last.catalogUrl||""}</div>
        ` : ""}
      </div>
    </div>
  `;
}

function onlyPublishedPayload(){
  const titles = cmsState.titles
    .filter(t => t.isPublished)
    .map(t => {
      const clone = JSON.parse(JSON.stringify(t));
      if(clone.type === "series"){
        clone.seasons = (clone.seasons||[]).map(season => {
          season.episodes = (season.episodes||[]).filter(ep => ep.isPublished);
          return season;
        });
      }
      return clone;
    });

  return {
    version: (cmsState.version||1) + 1,
    publishedAt: new Date().toISOString(),
    titles,
    loopChannel: cmsState.loopChannel,
    paymentPublic: {
      paypalClientId: cmsState.payment.paypalClientId,
      paypalEnv: cmsState.payment.paypalEnv
    },
    stableManifestKey: cmsState.publish.stableManifestKey || "manifest.json",
    stableCatalogKey: cmsState.publish.stableCatalogKey || "catalog.json"
  };
}

async function publishCatalog(){
  try{
    const payload = onlyPublishedPayload();

    const res = await fetch("/api/publish", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt);
    }

    const out = await res.json();
    cmsState.version = payload.version;
    cmsState.lastPublished = { time: Date.now(), ...out };
    saveState();

    const el = document.getElementById("publishResult");
    if(el){
      el.innerHTML = `✅ Published<br/>
        Manifest: ${out.stableManifestUrl || out.manifestUrl}<br/>
        Catalog: ${out.stableCatalogUrl || out.catalogUrl}`;
    }

    alert("Published!");
  }catch(e){
    logDebug("publishCatalog failed: " + e.message);
    alert("Publish failed: " + e.message);
  }
}

/* =====================
   INIT
===================== */
navTo("dashboard", {push:false});
</script>
</body>
</html>
