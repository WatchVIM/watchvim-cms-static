<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WatchVIM CMS Portal</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mux/mux-player" defer></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            watchBlack: "#0a0a0a",
            watchRed: "#e50914",
            watchGold: "#d4af37"
          }
        }
      }
    }
  </script>

  <style>
    html, body { background:#0a0a0a; color:#fff; }
    .active-link { background:#e50914 !important; color:white !important; }
    .input {
      width:100%; background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:12px; padding:.55rem .75rem; outline:none;
    }
    .input:focus { box-shadow:0 0 0 2px #d4af37; }
    .textarea { min-height:120px; }
    .card {
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:16px;
    }
    .btn {
      padding:.55rem 1rem; border-radius:12px; font-weight:600;
      transition:.15s; transform:translateZ(0);
    }
    .btn:active { transform:scale(.98); }
    .btn-primary { background:#e50914; }
    .btn-primary:hover { background:#f0141f; }
    .btn-ghost { background:rgba(255,255,255,0.08); }
    .btn-ghost:hover { background:rgba(255,255,255,0.14); }
    .btn-danger { background:#b91c1c; }
    .btn-danger:hover { background:#dc2626; }
    .badge {
      font-size:11px; padding:2px 8px; border-radius:999px;
      background:rgba(212,175,55,0.15); color:#d4af37;
      border:1px solid rgba(212,175,55,0.3);
    }
    .thumb {
      width: 180px; height: 102px; object-fit: cover;
      border-radius: 12px; border:1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.03);
    }
    .poster {
      width: 120px; height: 180px; object-fit: cover;
      border-radius: 12px; border:1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.03);
    }
    .episode-thumb {
      width: 140px; height: 80px; object-fit: cover;
      border-radius: 10px; border:1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.03);
    }
    .small { font-size: 12px; color: rgba(255,255,255,0.6); }
    code { background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 6px; }
    details summary { cursor:pointer; }
    .bar {
      height: 10px; border-radius: 999px; background: rgba(255,255,255,0.08);
      overflow: hidden;
    }
    .bar > div { height: 100%; background: #d4af37; }
  </style>
</head>

<body class="min-h-screen">
  <div id="root" class="min-h-screen"></div>

<script>
/* ==========================================================
   WatchVIM CMS — Single-file SPA
   + Vercel Blob image uploads (hero/poster)
   + NEW: Publish Catalog to Blob (manifest.json + catalog.json)
========================================================== */

const CONFIG = {
  useBackend: false,
  apiBaseUrl: "https://api.watchvim.com/cms"
};

const KEYS = {
  content:  "watchvim_cms_content",
  users:    "watchvim_cms_users",
  ads:      "watchvim_cms_ads",
  loop:     "watchvim_cms_loop",
  session:  "watchvim_cms_session",
  payments: "watchvim_cms_payments",
  analytics:"watchvim_cms_analytics"
};

const $ = (sel) => document.querySelector(sel);
const nowIso = () => new Date().toISOString();
const todayKey = () => new Date().toISOString().slice(0,10);
const uuid = () => (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()));
const cap = (s)=> (s||"").charAt(0).toUpperCase() + (s||"").slice(1);

function safeParse(raw, fallback){
  try { return raw ? JSON.parse(raw) : fallback; }
  catch { return fallback; }
}
function escapeHtml(str=""){
  return str.replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function val(v){ return v==null ? "" : String(v); }
function numOrUndef(v){ const n = Number(v); return Number.isFinite(n) && v!=="" ? n : undefined; }
function label(t){ return `<label class="text-sm text-white/70">${t}</label>`; }

let tempImages = { hero:null, poster:null };
let tempSeriesDraft = null;

/* ==========================================================
   SECTION BACK
========================================================== */
function getParentSectionRoute(hash){
  if(hash.startsWith("#/content/films")) return "#/content/films";
  if(hash.startsWith("#/content/series")) return "#/content/series";
  if(hash.startsWith("#/content/documentaries")) return "#/content/documentaries";
  if(hash.startsWith("#/users")) return "#/users";
  if(hash.startsWith("#/loop-channel")) return "#/loop-channel";
  if(hash.startsWith("#/settings/ads")) return "#/settings/ads";
  if(hash.startsWith("#/settings/payments")) return "#/settings/payments";
  return "#/dashboard";
}
function goBackSection(){
  location.hash = getParentSectionRoute(location.hash || "#/dashboard");
}
function goTo(hash){ location.hash = hash; }

/* ==========================================================
   ANALYTICS (local)
========================================================== */
function seedAnalytics(){
  return {
    totals: {
      titlesCreated:0, titlesEdited:0, titlesDeleted:0,
      seasonsCreated:0, seasonsDeleted:0,
      episodesCreated:0, episodesDeleted:0
    },
    dailyEdits: {},
    lastActions: []
  };
}
async function getAnalytics(){
  return safeParse(localStorage.getItem(KEYS.analytics), seedAnalytics());
}
async function saveAnalytics(a){
  localStorage.setItem(KEYS.analytics, JSON.stringify(a));
}
async function logAction(action, labelTxt){
  const a = await getAnalytics();
  const day = todayKey();
  a.dailyEdits[day] = (a.dailyEdits[day] || 0) + 1;
  a.lastActions.unshift({ at: nowIso(), action, label: labelTxt });
  a.lastActions = a.lastActions.slice(0, 20);
  await saveAnalytics(a);
}
async function bumpTotal(key, n=1){
  const a = await getAnalytics();
  a.totals[key] = (a.totals[key] || 0) + n;
  await saveAnalytics(a);
}
async function resetAnalytics(){
  localStorage.setItem(KEYS.analytics, JSON.stringify(seedAnalytics()));
}

/* ==========================================================
   NEW: PUBLISH CATALOG TO BLOB
========================================================== */
async function publishCatalog(){
  const statusEl = $("#publishStatus");
  if(statusEl) statusEl.textContent = "Publishing…";

  try{
    const content = await getContent(); // localStorage catalog
    const res = await fetch("/api/publish", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(content)
    });
    const data = await res.json();

    if(!res.ok){
      if(statusEl) statusEl.textContent = "Publish failed: " + (data.error||"unknown error");
      return;
    }

    if(statusEl){
      statusEl.innerHTML = `
        ✅ Published! Version: <b>${data.version}</b><br/>
        <div class="mt-1">
          <b>Manifest URL (use in ALL apps):</b><br/>
          <code style="word-break:break-all">${data.manifestUrl}</code>
        </div>
        <div class="mt-2">
          <b>Latest Catalog URL:</b><br/>
          <code style="word-break:break-all">${data.catalogUrl}</code>
        </div>
      `;
    }

    await logAction("Catalog Published", `v${data.version}`);
  }catch(e){
    if(statusEl) statusEl.textContent = "Publish failed: " + e.message;
  }
}

/* ---------------- Seed data ---------------- */
function seedContent(){
  const now = nowIso();
  return [
    {
      id:"seed-film-1",
      type:"films",
      title:"Nice Enough",
      synopsis:"A gripping thriller debuting on WatchVIM.",
      genre:["Thriller"],
      runtimeMins:102,
      releaseYear:2025,
      monetization:"ad_supported",
      isPublished:true,
      createdAt:now,
      updatedAt:now,
      heroImageDataUrl:"",
      posterImageDataUrl:"",
      mux: {
        trailerAssetId:"",
        trailerPlaybackId:"",
        contentAssetId:"",
        contentPlaybackId:""
      }
    },
    {
      id:"seed-series-1",
      type:"series",
      title:"Scottsdale",
      synopsis:"A drama series set in Arizona.",
      genre:["Drama"],
      releaseYear:2025,
      monetization:"svod",
      isPublished:true,
      createdAt:now,
      updatedAt:now,
      heroImageDataUrl:"",
      posterImageDataUrl:"",
      mux: { trailerAssetId:"", trailerPlaybackId:"" },
      seasons: [
        {
          id:"seed-season-1",
          seasonNumber:1,
          title:"Season 1",
          synopsis:"",
          episodes:[
            {
              id:"seed-ep-1",
              episodeNumber:1,
              title:"Pilot",
              synopsis:"",
              runtimeMins:42,
              isPublished:true,
              thumbDataUrl:"",
              mux:{
                trailerAssetId:"",
                trailerPlaybackId:"",
                contentAssetId:"",
                contentPlaybackId:""
              }
            }
          ]
        }
      ]
    }
  ];
}
function seedUsers(){
  const now = nowIso();
  return [
    { id:"seed-admin", name:"Anthony Bawn", email:"admin@watchvim.com", password:"watchvimadmin", role:"admin", isActive:true, createdAt:now },
    { id:"seed-editor", name:"WatchVIM Editor", email:"editor@watchvim.com", password:"watchvimeditor", role:"editor", isActive:true, createdAt:now },
    { id:"seed-viewer", name:"WatchVIM Viewer", email:"viewer@watchvim.com", password:"watchvimviewer", role:"viewer", isActive:true, createdAt:now }
  ];
}
function seedAds(){ return { gamNetworkCode:"", vastTagUrl:"", prerollEnabled:true, midrollEnabled:false, postrollEnabled:false }; }
function seedLoop(){ return { channelName:"WatchVIM Live Loop", isLive:false, startTime:"", endTime:"", rotationTitleIds:[] }; }
function seedPayments(){ return { paypalClientId:"", paypalEnv:"sandbox" }; }

/* ---------------- Data layer ---------------- */
async function getContent(){
  return safeParse(localStorage.getItem(KEYS.content), seedContent());
}
async function saveContent(items){
  localStorage.setItem(KEYS.content, JSON.stringify(items));
}
async function upsertContent(item, modeHint="edit"){
  const items = await getContent();
  const idx = items.findIndex(i=>i.id===item.id);
  if(idx>=0) items[idx]=item; else items.unshift(item);
  await saveContent(items);

  if(modeHint==="new"){
    await bumpTotal("titlesCreated");
    await logAction("Title Created", `${item.type}: ${item.title}`);
  } else {
    await bumpTotal("titlesEdited");
    await logAction("Title Edited", `${item.type}: ${item.title}`);
  }
}
async function deleteContent(id){
  const items = await getContent();
  const removed = items.find(i=>i.id===id);
  await saveContent(items.filter(i=>i.id!==id));
  await bumpTotal("titlesDeleted");
  if(removed) await logAction("Title Deleted", `${removed.type}: ${removed.title}`);
}
async function getUsers(){
  return safeParse(localStorage.getItem(KEYS.users), seedUsers());
}
async function saveUsers(items){
  localStorage.setItem(KEYS.users, JSON.stringify(items));
}
async function getAdsSettings(){
  return safeParse(localStorage.getItem(KEYS.ads), seedAds());
}
async function saveAdsSettings(settings){
  localStorage.setItem(KEYS.ads, JSON.stringify(settings));
}
async function getLoopSettings(){
  return safeParse(localStorage.getItem(KEYS.loop), seedLoop());
}
async function saveLoopSettings(settings){
  localStorage.setItem(KEYS.loop, JSON.stringify(settings));
}
async function getPaymentsSettings(){
  return safeParse(localStorage.getItem(KEYS.payments), seedPayments());
}
async function savePaymentsSettings(settings){
  localStorage.setItem(KEYS.payments, JSON.stringify(settings));
}

/* ---------------- Session ---------------- */
function getSession(){ return safeParse(localStorage.getItem(KEYS.session), null); }
function setSession(user){ localStorage.setItem(KEYS.session, JSON.stringify(user)); }
function clearSession(){ localStorage.removeItem(KEYS.session); }
function hasRole(user, allowed){ return user && allowed.includes(user.role); }

async function login(email, password){
  const users = await getUsers();
  const u = users.find(x => x.email.toLowerCase()===email.toLowerCase());
  if(!u || !u.isActive) return { ok:false, msg:"User not found or inactive." };
  if(u.password !== password) return { ok:false, msg:"Incorrect password." };
  setSession({ id:u.id, name:u.name, email:u.email, role:u.role });
  return { ok:true };
}

/* ---------------- Shell ---------------- */
function renderShell(){
  const user = getSession();
  if(!user){ renderLogin(); return; }

  $("#root").innerHTML = `
    <div class="flex min-h-screen">
      <aside class="w-[260px] bg-black border-r border-white/5 p-4 flex flex-col gap-2">
        <div class="px-3 py-2 rounded-xl bg-white/5 mb-2">
          <div class="text-watchGold font-bold text-lg">WatchVIM</div>
          <div class="text-xs text-white/60">CMS Portal</div>
        </div>
        <div class="px-3 py-2 text-xs text-white/70 flex items-center justify-between bg-white/5 rounded-xl">
          <span>${escapeHtml(user.name)}</span>
          <span class="badge">${user.role}</span>
        </div>
        <nav id="sidebarNav" class="flex flex-col gap-1 mt-2"></nav>
      </aside>

      <main class="flex-1 bg-watchBlack">
        <header class="flex items-center justify-between px-6 py-4 border-b border-white/5 bg-watchBlack">
          <div class="flex items-center gap-3">
            <button id="globalBackBtn" class="btn btn-ghost text-sm" onclick="goBackSection()">← Back</button>
            <h1 id="pageTitle" class="text-xl font-semibold">Dashboard</h1>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-sm text-white/60">${escapeHtml(user.email)}</div>
            <button class="btn btn-ghost text-sm" onclick="handleLogout()">Logout</button>
          </div>
        </header>
        <div id="app" class="p-6 space-y-6"></div>
      </main>
    </div>
  `;

  renderSidebar();
  router();
}

function renderLogin(){
  $("#root").innerHTML = `
    <div class="min-h-screen flex items-center justify-center p-6">
      <div class="w-full max-w-md card p-6 space-y-4">
        <div class="text-center">
          <div class="text-watchGold font-bold text-2xl">WatchVIM</div>
          <div class="text-white/60 text-sm">CMS Portal Login</div>
        </div>
        <div class="space-y-2">
          ${label("Email")}
          <input id="login_email" class="input" placeholder="admin@watchvim.com"/>
        </div>
        <div class="space-y-2">
          ${label("Password")}
          <input id="login_pass" class="input" type="password" placeholder="••••••••"/>
        </div>
        <button class="w-full btn btn-primary" onclick="handleLogin()">Sign In</button>
        <div id="login_msg" class="text-sm text-red-400"></div>

        <div class="text-xs text-white/50 pt-2 border-t border-white/10">
          Demo accounts:
          <ul class="list-disc pl-5 mt-1">
            <li>admin@watchvim.com / watchvimadmin</li>
            <li>editor@watchvim.com / watchvimeditor</li>
            <li>viewer@watchvim.com / watchvimviewer</li>
          </ul>
        </div>
      </div>
    </div>
  `;
}

async function handleLogin(){
  const email = $("#login_email").value.trim();
  const pass  = $("#login_pass").value.trim();
  const msg = $("#login_msg");
  msg.textContent = "";

  const res = await login(email, pass);
  if(!res.ok){ msg.textContent = res.msg || "Login failed."; return; }

  location.hash = "#/dashboard";
  renderShell();
}
function handleLogout(){ clearSession(); renderShell(); }

/* ---------------- Routes ---------------- */
const routes = [
  { path:"#/dashboard", label:"Dashboard", roles:["admin","editor","viewer"], render:renderDashboard },
  { path:"#/content/films", label:"Films", roles:["admin","editor","viewer"], render:()=>renderContentList("films") },
  { path:"#/content/series", label:"Series", roles:["admin","editor","viewer"], render:()=>renderContentList("series") },
  { path:"#/content/documentaries", label:"Documentaries", roles:["admin","editor","viewer"], render:()=>renderContentList("documentaries") },
  { path:"#/loop-channel", label:"Loop Channel", roles:["admin","editor"], render:renderLoopChannel },
  { path:"#/users", label:"Users", roles:["admin"], render:renderUsers },
  { path:"#/settings/ads", label:"Ads (GAM/VAST)", roles:["admin"], render:renderAds },
  { path:"#/settings/payments", label:"Payments", roles:["admin"], render:renderPayments }
];

function renderSidebar(){
  const user = getSession();
  $("#sidebarNav").innerHTML = routes
    .filter(r => hasRole(user, r.roles))
    .map(r=>`
      <a href="${r.path}" class="nav-link flex items-center gap-3 px-3 py-2 rounded-xl text-sm transition text-white/80 hover:bg-white/5">
        <span class="opacity-80">•</span>
        <span>${r.label}</span>
      </a>
    `).join("");
}

function setActiveLink(){
  const href = location.hash || "#/dashboard";
  document.querySelectorAll(".nav-link").forEach(a=>{
    a.classList.toggle("active-link", a.getAttribute("href")===href);
  });
}

function router(){
  const user = getSession();
  if(!user){ renderLogin(); return; }

  const hash = location.hash || "#/dashboard";
  const route = routes.find(r=>r.path===hash);
  if(!route){ location.hash = "#/dashboard"; return; }

  if(!hasRole(user, route.roles)){
    $("#pageTitle").textContent = "Access Denied";
    renderAccessDenied(route.roles);
    setActiveLink();
    return;
  }

  $("#pageTitle").textContent = route.label;

  const backBtn = $("#globalBackBtn");
  if(backBtn) backBtn.style.display = (hash==="#/dashboard") ? "none" : "inline-flex";

  route.render();
  setActiveLink();
}
window.addEventListener("hashchange", router);

function renderAccessDenied(roles){
  $("#app").innerHTML = `
    <div class="card p-6">
      <h2 class="text-lg font-semibold mb-2">Access Denied</h2>
      <p class="text-white/70 text-sm">
        This page requires one of these roles: <b>${roles.join(", ")}</b>.
      </p>
    </div>
  `;
}

/* ---------------- Dashboard (UPDATED) ---------------- */
async function renderDashboard(){
  const content = await getContent();
  const a = await getAnalytics();

  const films = content.filter(c=>c.type==="films");
  const series = content.filter(c=>c.type==="series");
  const docs = content.filter(c=>c.type==="documentaries");

  const published = content.filter(c=>c.isPublished).length;
  const drafts = content.length - published;

  const seasonCount = series.reduce((acc,s)=>acc+(s.seasons?.length||0),0);
  const episodeCount = series.reduce((acc,s)=>
    acc + (s.seasons||[]).reduce((a2,season)=>a2+(season.episodes?.length||0),0)
  ,0);

  const monetizationCounts = content.reduce((acc,c)=>{
    const k = c.monetization || "unset";
    acc[k]=(acc[k]||0)+1;
    return acc;
  }, {});
  const maxMono = Math.max(1, ...Object.values(monetizationCounts));

  const contentBytes = (localStorage.getItem(KEYS.content)||"").length;
  const approxMb = (contentBytes / (1024*1024)).toFixed(2);

  $("#app").innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      ${statCard("Films", films.length)}
      ${statCard("Series", series.length)}
      ${statCard("Documentaries", docs.length)}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      ${statCard("Published", published)}
      ${statCard("Drafts", drafts)}
      ${statCard("Seasons", seasonCount)}
      ${statCard("Episodes", episodeCount)}
    </div>

    <!-- NEW PUBLISH CARD -->
    <div class="card p-5 space-y-3">
      <div class="font-semibold text-lg">Publish to Frontend + Apps</div>
      <div class="text-sm text-white/70">
        Clicking publish uploads a <b>manifest.json</b> and a versioned <b>catalog.json</b>
        to Vercel Blob. Use the manifest URL in your frontend, iOS/Android, Apple TV, Fire TV, Roku, etc.
      </div>
      <button class="btn btn-primary w-full md:w-auto" onclick="publishCatalog()">
        Publish Catalog to Apps
      </button>
      <div id="publishStatus" class="text-sm text-white/80"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card p-5 space-y-3">
        <div class="font-semibold">Monetization Mix</div>
        ${Object.keys(monetizationCounts).map(k=>{
          const v = monetizationCounts[k];
          const pct = Math.round((v/maxMono)*100);
          return `
            <div class="space-y-1">
              <div class="flex justify-between text-sm text-white/80">
                <span>${k}</span><span>${v}</span>
              </div>
              <div class="bar"><div style="width:${pct}%"></div></div>
            </div>
          `;
        }).join("")}
      </div>

      <div class="card p-5 space-y-3">
        <div class="font-semibold">CMS Activity</div>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="card p-3 bg-black/40">
            <div class="text-white/60">Titles Created</div>
            <div class="text-xl font-bold">${a.totals.titlesCreated||0}</div>
          </div>
          <div class="card p-3 bg-black/40">
            <div class="text-white/60">Titles Edited</div>
            <div class="text-xl font-bold">${a.totals.titlesEdited||0}</div>
          </div>
          <div class="card p-3 bg-black/40">
            <div class="text-white/60">Titles Deleted</div>
            <div class="text-xl font-bold">${a.totals.titlesDeleted||0}</div>
          </div>
          <div class="card p-3 bg-black/40">
            <div class="text-white/60">Seasons / Episodes Added</div>
            <div class="text-xl font-bold">${a.totals.seasonsCreated||0} / ${a.totals.episodesCreated||0}</div>
          </div>
        </div>

        <div class="text-sm text-white/60 pt-2">
          Storage used (content only): ~${approxMb} MB
        </div>

        <button class="btn btn-ghost text-sm w-full" onclick="resetAnalytics(); renderDashboard();">
          Reset Analytics (local)
        </button>
      </div>
    </div>

    <div class="card p-5 space-y-3">
      <div class="font-semibold">Recent Activity</div>
      ${
        (a.lastActions||[]).length
          ? `<div class="space-y-2">
              ${(a.lastActions||[]).map(x=>`
                <div class="flex justify-between text-sm bg-black/40 border border-white/5 rounded-xl p-3">
                  <div>
                    <div class="font-semibold">${escapeHtml(x.action||"")}</div>
                    <div class="text-white/60">${escapeHtml(x.label||"")}</div>
                  </div>
                  <div class="text-white/50">${new Date(x.at||Date.now()).toLocaleString()}</div>
                </div>
              `).join("")}
            </div>`
          : `<div class="text-sm text-white/60">No activity yet.</div>`
      }
    </div>
  `;
}
function statCard(labelTxt, value){
  return `
    <div class="card p-4">
      <div class="text-sm text-white/60">${labelTxt}</div>
      <div class="text-2xl font-bold mt-1">${value}</div>
    </div>
  `;
}

/* ==========================================================
   THE REST OF YOUR CMS CODE CONTINUES UNCHANGED
   (content list, forms, Blob image upload, series drilldown,
    users, loop channel, ads, payments, etc.)
========================================================== */

/* ---------------- Content list ---------------- */
async function renderContentList(type){
  const user = getSession();
  const items = (await getContent()).filter(c=>c.type===type);
  const title = cap(type);
  const canEdit = hasRole(user, ["admin","editor"]);

  $("#app").innerHTML = `
    <div class="flex items-center justify-between">
      <div class="text-white/70 text-sm">
        Manage ${title}. Hero 1920×1080 • Poster 214×321
      </div>
      ${
        canEdit
          ? `<button class="btn btn-primary" onclick="openNewContentForm('${type}')">Add New</button>`
          : `<div class="text-xs text-white/50">Viewer mode (read-only)</div>`
      }
    </div>

    <div class="overflow-x-auto rounded-2xl border border-white/10">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-white/70">
          <tr>
            <th class="text-left p-3">Title</th>
            ${type==="series" ? `<th class="text-left p-3">Seasons / Episodes</th>` : `<th class="text-left p-3">Mux</th>`}
            <th class="text-left p-3">Monetization</th>
            <th class="text-left p-3">Published</th>
            <th class="text-left p-3">Updated</th>
            <th class="text-right p-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${items.length ? items.map(row=>contentRow(row, canEdit)).join("") : emptyRow("No titles yet.")}
        </tbody>
      </table>
    </div>
  `;
}
function contentRow(i, canEdit){
  const muxOk = (i.mux?.trailerPlaybackId || i.mux?.contentPlaybackId) ? "Connected" : "—";
  const seasons = i.seasons?.length || 0;
  const episodes = (i.seasons||[]).reduce((acc,s)=>acc+(s.episodes?.length||0),0);

  return `
    <tr class="border-t border-white/5">
      <td class="p-3 font-medium">${escapeHtml(i.title)}</td>
      ${
        i.type==="series"
          ? `<td class="p-3">${seasons} seasons / ${episodes} eps</td>`
          : `<td class="p-3">${muxOk}</td>`
      }
      <td class="p-3">${i.monetization}</td>
      <td class="p-3">${i.isPublished?"Yes":"No"}</td>
      <td class="p-3">${new Date(i.updatedAt).toLocaleDateString()}</td>
      <td class="p-3 text-right">
        ${
          canEdit
            ? `
              <button class="btn btn-ghost text-xs mr-2" onclick="openEditContentForm('${i.id}')">Edit</button>
              <button class="btn btn-danger text-xs" onclick="handleDeleteContent('${i.id}','${i.type}')">Delete</button>
            `
            : `<span class="text-xs text-white/40">—</span>`
        }
      </td>
    </tr>
  `;
}
function emptyRow(msg){
  return `<tr><td class="p-6 text-white/60" colspan="6">${msg}</td></tr>`;
}

/* ... keep the rest of your previous CMS JS here exactly as-is ... */

/* ---------------- Boot ---------------- */
renderShell();
</script>
</body>
</html>
